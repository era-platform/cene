<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!--
staccato-runner-mini.html (part of Era Cene)
Copyright 2015, 2016 Ross Angle. Released under the MIT License.
-->
<title>Era Staccato demo</title>
</head>
<body>
<p><a href="https://github.com/rocketnia/era-cene"
    >View the Era Cene project on GitHub.</a></p>

<p>This page merely loads Staccato without actually using it for much.
Check the console to see if there are errors. If there aren't, great!
Nothing to see here.</p>

<p>This page loads the Staccato source code from a file called
"fin/era-staccato-lib.stc.js" in the repo directory. To use this page,
you must obtain era-staccato-lib.stc.js in one of two ways:</p>

<ul>
    <li>Install Node.js. From the repo directory, run the command
    "<kbd>npm install</kbd>" followed by the command
    "<kbd>node cene.js --build-staccato</kbd>".</li>
    <li>Check out the <code>gh-pages</code> branch, which contains the
    files automatically built by Travis CI.</li>
</ul>

<p>Alternatively, you can view the latest version of this page
<a href=
    "http://rocketnia.github.io/era/demos/staccato-runner-mini.html"
>online</a>.</p>

<script type="text/javascript" src="../buildlib/lathe.js"></script>
<script type="text/javascript" src="../fin/era-staccato-lib.stc.js">
    </script>
<script type="text/javascript"
    src="../fin/era-staccato-self-compiler.stc.js"></script>
<script type="text/javascript" src="../fin/test.stc.js"></script>
<script type="text/javascript" src="../src/era-misc-strmap-avl.js">
    </script>
<script type="text/javascript" src="../src/era-misc.js"></script>
<script type="text/javascript" src="../src/era-reader.js"></script>
<script type="text/javascript"
    src="../src/era-staccato-lib-runner-mini.js"></script>
<script type="text/javascript" src="../src/era-cene-api.js"></script>
<script type="text/javascript">"use strict";

window.onload = function () {
    var _ = rocketnia.lathe;
    
    function generateOutput() {
        var startMillis = new Date().getTime();
        
        var files = [
            "era-staccato-lib.stc",
            "era-staccato-self-compiler.stc"
        ];
        var testFile = "test.stc";
        
        function readFile( file ) {
            return rocketnia.eraFiles[ file ];
        }
        
        var codeOfFiles = arrMappend( files, function ( file ) {
            return readAll( readFile( file ) );
        } );
        var testCode = readAll( readFile( testFile ) );
        var readMillis = new Date().getTime();
        
        var nss = {
            definitionNs: stcNsGet( "definition-ns", stcNsRoot() ),
            uniqueNs: stcNsGet( "unique-ns", stcNsRoot() )
        };
        
        var usingDefNs = usingDefinitionNs( nss.definitionNs );
        var ceneApiUsingDefNs =
            ceneApiUsingDefinitionNs( nss.definitionNs, {
                defer: function ( body ) {
                    _.defer( body );
                },
                cliArguments: function () {
                    return [];
                },
                cliInputDirectory: function () {
                    return null;
                },
                cliOutputDirectory: function () {
                    return null;
                },
                inputPathGet: function ( inputPath, name ) {
                    return null;
                },
                inputPathType: function ( inputPath ) {
                    return { type: "missing" };
                },
                inputPathDirectoryList: function ( inputPath ) {
                    throw new Error();
                },
                inputPathBlobUtf8: function ( inputPath ) {
                    throw new Error();
                },
                outputPathGet: function ( inputPath, name ) {
                    return null;
                },
                outputPathDirectory: function ( outputPath ) {
                    // Do nothing.
                },
                outputPathBlobUtf8:
                    function ( outputPath, outputString ) {
                    
                    // Do nothing.
                },
                sloppyJavaScriptQuine:
                    function ( constructorTag, topLevelVars ) {
                    
                    return null;
                },
                onDependenciesComplete: function ( listener ) {
                    // Do nothing.
                },
                getTopLevelVar: function ( varName ) {
                    throw new Error();
                },
                setTopLevelVar: function ( varName, val ) {
                    throw new Error();
                }
            } );
        
        usingDefNs.stcAddCoreMacros( nss.definitionNs );
        usingDefNs.processCoreTypes( nss.definitionNs );
        ceneApiUsingDefNs.addCeneApi( nss.definitionNs );
        
        usingDefNs.runTopLevelTryExprsSync( nss,
            [].concat( codeOfFiles, testCode ) );
        
        var stopMillis = new Date().getTime();
        // TODO: Either remove this or display it more prominently.
        console.log(
            "Ran for " + (stopMillis - startMillis) / 1000 + " " +
            "seconds, broken down as follows:" );
        console.log(
            "- Spent " + (readMillis - startMillis) / 1000 + " " +
            "seconds reading the code." );
        console.log(
            "- Spent " + (stopMillis - readMillis) / 1000 + " " +
            "seconds processing it." );
    }
    generateOutput();
};
</script>
</body>
</html>
