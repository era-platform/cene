<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!--
cene.html (part of Era Cene)
Copyright 2015, 2016 Ross Angle. Released under the MIT License.
-->
<title>Era Cene demo</title>
</head>
<body>
<p><a href="https://github.com/rocketnia/era-cene"
    >View the Era Cene project on GitHub.</a></p>

<p>This page merely loads Cene without actually using it for much.
Check the console to see if there are errors. If there aren't, great!
Nothing to see here.</p>

<p>This page loads the Cene source code from files called
"fin/era-cene-prelude.cene.js", "fin/era-quasiquote.cene.js", and
"fin/test.cene.js" in the repo directory. To use this page, you must
obtain these files in one of two ways:</p>

<ul>
    <li>Install Node.js. From the repo directory, run the command
    "<kbd>npm install</kbd>" followed by the command
    "<kbd>node cene.js --demo-cene</kbd>".</li>
    <li>Check out the <code>gh-pages</code> branch, which contains the
    files automatically built by Travis CI.</li>
</ul>

<p>Alternatively, you can view the latest version of this page
<a href="https://rocketnia.github.io/era-cene/demos/cene.html"
>online</a>.</p>

<script type="text/javascript" src="../buildlib/lathe.js"></script>
<script type="text/javascript" src="../fin/era-cene-prelude.cene.js">
    </script>
<script type="text/javascript" src="../fin/era-quasiquote.cene.js">
    </script>
<script type="text/javascript" src="../fin/test.cene.js"></script>
<script type="text/javascript" src="../src/era-misc-strmap-avl.js">
    </script>
<script type="text/javascript" src="../src/era-misc.js"></script>
<script type="text/javascript" src="../src/era-reader.js"></script>
<script type="text/javascript" src="../src/era-code-gen-js.js">
    </script>
<script type="text/javascript" src="../src/era-cene-runtime.js">
    </script>
<script type="text/javascript" src="../src/era-cene-api.js"></script>
<script type="text/javascript">"use strict";

window.onload = function () {
    var _ = rocketnia.lathe;
    
    function generateOutput() {
        var startMillis = new Date().getTime();
        
        var files = [
            "era-cene-prelude.cene",
            "era-quasiquote.cene"
        ];
        var testFile = "test.cene";
        
        function readFile( file ) {
            return rocketnia.eraFiles[ file ];
        }
        
        var codeOfFiles = arrMappend( files, function ( file ) {
            return readAll( readFile( file ) );
        } );
        var testCode = readAll( readFile( testFile ) );
        var readMillis = new Date().getTime();
        
        var nss = {
            uniqueNs: sinkNsGet( "unique-ns", sinkNsRoot() ),
            definitionNs: sinkNsGet( "definition-ns", sinkNsRoot() ),
            qualify: rootQualify
        };
        var funcDefNs =
            sinkNsGet( "function-implementations-ns", sinkNsRoot() );
        
        var usingDefNs = usingFuncDefNs( funcDefNs );
        
        var namespaceDefs = jsnMap();
        
        var ceneApiUsingDefNs =
            ceneApiUsingFuncDefNs( namespaceDefs, nss.funcDefNs, {
                defer: function ( body ) {
                    _.defer( body );
                },
                cliArguments: function () {
                    return [];
                },
                cliInputDirectory: function () {
                    return null;
                },
                cliOutputDirectory: function () {
                    return null;
                },
                inputPathGet: function ( inputPath, name ) {
                    return null;
                },
                inputPathType: function ( inputPath ) {
                    return { type: "missing" };
                },
                inputPathDirectoryList: function ( inputPath ) {
                    throw new Error();
                },
                inputPathBlobUtf8: function ( inputPath ) {
                    throw new Error();
                },
                outputPathGet: function ( inputPath, name ) {
                    return null;
                },
                outputPathDirectory: function ( outputPath ) {
                    // Do nothing.
                },
                outputPathBlobUtf8:
                    function ( outputPath, outputString ) {
                    
                    // Do nothing.
                },
                sloppyJavaScriptQuine:
                    function ( cexpr, topLevelVars ) {
                    
                    return null;
                },
                onDependenciesComplete: function ( listener ) {
                    // Do nothing.
                },
                getTopLevelVar: function ( varName ) {
                    throw new Error();
                },
                setTopLevelVar: function ( varName, val ) {
                    throw new Error();
                }
            } );
        
        usingDefNs.addCoreMacros(
            namespaceDefs, nss.definitionNs, funcDefNs );
        usingDefNs.processCoreStructs(
            namespaceDefs, nss.definitionNs );
        ceneApiUsingDefNs.addCeneApi( nss.definitionNs, funcDefNs );
        
        usingDefNs.runTopLevelTryExprsSync( namespaceDefs, nss,
            [].concat( codeOfFiles, testCode ) );
        
        var stopMillis = new Date().getTime();
        // TODO: Either remove this or display it more prominently.
        console.log(
            "Ran for " + (stopMillis - startMillis) / 1000 + " " +
            "seconds, broken down as follows:" );
        console.log(
            "- Spent " + (readMillis - startMillis) / 1000 + " " +
            "seconds reading the code." );
        console.log(
            "- Spent " + (stopMillis - readMillis) / 1000 + " " +
            "seconds processing it." );
    }
    generateOutput();
};
</script>
</body>
</html>
