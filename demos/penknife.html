<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!--
penknife.html (part of Era)
Copyright 2013 Ross Angle. Released under the MIT License.
-->
<title>Era Penknife demo</title>
<style type="text/css">
textarea { display: block; }
</style>
</head>
<body>
<p><a href="https://github.com/rocketnia/era"
    >View the Era project on GitHub.</a></p>
<p><a href="https://github.com/rocketnia/penknife"
    >View the old Penknife project on GitHub.</a></p>

<textarea id="code" cols="80" rows="24">
(nil)
(yep (nil))
(cons (nil) (nil))
(yep/nil) :cons (nil)
((fn x (cons x x)) (nil) (nil))
((fn x ((fn x (cons x x)) x x)) (nil) (nil))

(defval (string-name quote.list) /fn x x)
(list quote.a quote.b)

(defval (string-name quote.curried-example) /fn x /fn y (cons y x))
((curried-example (nil)) (yep/nil))
</textarea>
<button id="go">Execute</button>
<textarea id="result" disabled cols="80" rows="24"></textarea>

<script type="text/javascript" src="../src/era-misc.js"></script>
<script type="text/javascript" src="../src/era-reader.js"></script>
<script type="text/javascript" src="../src/era-penknife.js"></script>
<script type="text/javascript">"use strict";

// Turns out the reader is very slow right now because it makes
// frequent use of setTimeout() for control flow. This redefinition of
// `defer` is hackish, but it definitely fixes the speed issue.
var deferTrampolineEvents = [];
defer = function ( func ) {
    deferTrampolineEvents.push( func );
};
function runDeferTrampoline() {
    while ( deferTrampolineEvents.length !== 0 )
        deferTrampolineEvents.pop()();
};

window.onload = function () {
    function read( stream, onEnd, onFailure, onSuccess ) {
        reader( {
            stream: stream,
            readerMacros: readerMacros,
            heedsCommandEnds: true,
            infixLevel: 0,
            infixState: { type: "empty" },
            end: function ( $ ) {
                if ( $.infixState.type === "ready" )
                    $.then( { ok: true, val: $.infixState.val } );
                else
                    onEnd();
                runDeferTrampoline();
            },
            unrecognized: function ( $ ) {
                $.then( { ok: false,
                    msg: "Encountered an unrecognized character" } );
                runDeferTrampoline();
            },
            then: function ( result ) {
                if ( result.ok )
                    onSuccess( result.val );
                else
                    onFailure( result.msg );
            }
        } );
        runDeferTrampoline();
    }
    function readAll() {
        var penknife = makePkRuntime();
        var stream = stringStream(
            document.getElementById( "code" ).value );
        readNext( [] );
        function readNext( resultsSoFar ) {
            read( stream, function () {  // onEnd
                show( resultsSoFar );
            }, function ( message ) {  // onFailure
                show( resultsSoFar.concat(
                    [ { ok: false, msg: message } ] ) );
            }, function ( result ) {  // onSuccess
                readNext( resultsSoFar.concat(
                    [ { ok: true, val: result } ] ) );
            } );
        }
        function show( results ) {
            var displays = [];
            for ( var i = 0, n = results.length; i < n; i++ ) {
                var result = results[ i ];
                if ( !result.ok ) {
                    displays.push( "Parse error: " + result.msg );
                    break;
                }
                var macroexpanded =
                    penknife.conveniences_macroexpandArrays(
                        result.val ).result;
                if ( macroexpanded.tag === "nope" ) {
                    displays.push(
                        "Macroexpansion error: " +
                        macroexpanded.ind( 0 ) );
                    break;
                } else if ( macroexpanded.tag !== "yep" ) {
                    displays.push(
                        "Poorly wrapped macroexpansion error: " +
                        macroexpanded );
                    break;
                } else {
//                    displays.push(
//                        "Macroexpansion: " +
//                        macroexpanded.ind( 0 ) );
                }
                var interpreted =
                    penknife.conveniences_interpretBinding(
                        macroexpanded.ind( 0 ) ).result;
                if ( interpreted.tag === "nope" ) {
                    displays.push(
                        "Interpretation error: " +
                        interpreted.ind( 0 ) );
                    break;
                } else if ( interpreted.tag !== "yep" ) {
                    displays.push(
                        "Poorly wrapped interpretation error: " +
                        interpreted );
                    break;
                } else {
                    displays.push( "" + interpreted.ind( 0 ) );
//                    displays.push( "" );
                }
                // NOTE: We respect linearity already. A linear value
                // won't be returned from macroexpansion or
                // interpretation because no linear values go in.
            }
            document.getElementById( "result" ).value =
                displays.join( "\n" );
        }
    }
    document.getElementById( "go" ).onclick = readAll;
    readAll();
};
</script>
</body>
</html>
