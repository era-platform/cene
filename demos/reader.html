<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!--
reader.html (part of Era)
Copyright 2013 Ross Angle. Released under the MIT License.
-->
<title>Era reader demo</title>
<style type="text/css">
textarea { display: block; }
</style>
</head>
<body>
<p><a href="https://github.com/rocketnia/era">View the Era project on GitHub.</a></p>

<textarea id="code" cols="80" rows="24">
; This reads as the string "foo".
foo

; This is the string "12".
12

; Strings can contain letters, numbers, and the '-' and '*'
; punctuation characters.

; This is the Array [ "a", "b", "c" ].
(a b c)

; This is the Array [ "a", "b", "c" ] in tertiary infix notation.
b :a c

; This is the Array [ "a", "b" ] in binary infix notation. Lisp
; dialects usually use the '.' character for dotted lists, but this
; syntax uses it for infix instead.
a.b

; The "b :a c" operator has lower precedence than the "a.b" operator,
; so this is [ [ "a", "b" ], [ "c", "d" ], [ "e", "f" ] ].
c.d :a.b e.f

; The "a.b" operator is left-associative, so this is
; [ [ "a", "b" ], "c" ].
a.b.c

; The "b :a c" operator is left-associative, so this is
; [ "a", [ "b", "c", "d" ], "e" ].
c :b d :a e

; The / reader macro is like ( but doesn't consume ). Thus, the
; following is shorthand for (a b (c d)).
(a b /c d)

a(This is all a single string. The reader macro that handles string
characters (like "a") will continue until the parens in the string are
matched.
)b()()c(
    This is still the same string.
)
</textarea>
<button id="read">Read</button>
<textarea id="result" disabled cols="80" rows="24"></textarea>

<script type="text/javascript" src="../src/era-misc-strmap-avl.js">
    </script>
<script type="text/javascript" src="../src/era-misc.js"></script>
<script type="text/javascript" src="../src/era-reader.js"></script>
<script type="text/javascript">"use strict";

// Turns out the reader is very slow right now because it makes
// frequent use of setTimeout() for control flow. This redefinition of
// `defer` is hackish, but it definitely fixes the speed issue.
var deferTrampolineEvents = [];
defer = function ( func ) {
    deferTrampolineEvents.push( func );
};
function runDeferTrampoline() {
    while ( deferTrampolineEvents.length !== 0 )
        deferTrampolineEvents.pop()();
};

window.onload = function () {
    function read( stream, onEnd, onFailure, onSuccess ) {
        reader( {
            stream: stream,
            readerMacros: readerMacros,
            heedsCommandEnds: true,
            infixLevel: 0,
            infixState: { type: "empty" },
            end: function ( $ ) {
                if ( $.infixState.type === "ready" )
                    $.then( { ok: true, val: $.infixState.val } );
                else
                    onEnd();
                runDeferTrampoline();
            },
            unrecognized: function ( $ ) {
                $.then( { ok: false,
                    msg: "Encountered an unrecognized character" } );
                runDeferTrampoline();
            },
            then: function ( result ) {
                if ( result.ok )
                    onSuccess( result.val );
                else
                    onFailure( result.msg );
            }
        } );
        runDeferTrampoline();
    }
    function readAll() {
        var stream = stringStream(
            document.getElementById( "code" ).value );
        readNext( [] );
        function readNext( resultsSoFar ) {
            read( stream, function () {  // onEnd
                show( resultsSoFar );
            }, function ( message ) {  // onFailure
                show( resultsSoFar.concat(
                    [ "Error: " + message ] ) );
            }, function ( result ) {  // onSuccess
                readNext( resultsSoFar.concat(
                    [ JSON.stringify( result, null, "    " ) ] ) );
            } );
        }
        function show( results ) {
            document.getElementById( "result" ).value =
                results.join( "\n" );
        }
    }
    document.getElementById( "read" ).onclick = readAll;
    readAll();
};
</script>
</body>
</html>
